---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { novelSources } from "../../data/novelSources";
import { loadNovel } from "../../lib/loadNovel";

export async function getStaticPaths() {
  const loaded = await Promise.all(novelSources.map((source) => loadNovel(source)));
  return loaded.map((novel) => ({ params: { slug: novel.slug }, props: { novel } }));
}

const { novel } = Astro.props;
const withBase = (path: string) => `${import.meta.env.BASE_URL}${path.replace(/^\//, "")}`;
---

<BaseLayout title={`${novel.workTitle} | Novel`} description={novel.lead}>
  <article class="reader-grid">
    <aside class="panel toc" aria-label="章目次">
      <p class="kicker">NOVEL READER</p>
      <h1>{novel.workTitle}</h1>
      <p class="lead">{novel.lead}</p>
      <div class="actions">
        <a class="btn" href={withBase("/works")}>作品一覧へ</a>
      </div>
      <h2>章目次</h2>
      <ol>
        {novel.chapters.map((chapter) => (
          <li><a href={`#${chapter.id}`}>{chapter.heading}</a></li>
        ))}
      </ol>
      <p class="source">
        Source:
        <a href={novel.sourceUrl}>{novel.sourceUrl}</a>
      </p>
      {novel.fetchError && <p class="error">取得状態: {novel.fetchError}</p>}
    </aside>

    <section class="panel content">
      {novel.chapters.map((chapter) => (
        <section class="chapter" id={chapter.id}>
          <h2>{chapter.heading}</h2>
          {chapter.body.split("\n\n").map((paragraph: string) => <p>{paragraph}</p>)}
        </section>
      ))}
    </section>
  </article>
</BaseLayout>

<style>
  .reader-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 0.95rem;
    align-items: start;
  }

  .toc {
    position: sticky;
    top: 6.1rem;
  }

  .kicker {
    margin: 0;
    font-size: 0.76rem;
    letter-spacing: 0.1em;
    color: var(--ok);
    font-weight: 700;
  }

  h1 {
    margin: 0.25rem 0 0;
    font-size: 1.45rem;
  }

  .lead {
    margin: 0.45rem 0 0;
    color: var(--muted);
    font-size: 0.95rem;
  }

  .actions {
    margin-top: 0.7rem;
  }

  .toc h2 {
    margin: 0.9rem 0 0.35rem;
    font-size: 1rem;
  }

  .toc ol {
    margin: 0;
    padding-left: 1.1rem;
  }

  .toc li {
    margin: 0.16rem 0;
  }

  .source {
    margin: 0.9rem 0 0;
    font-size: 0.75rem;
    color: var(--muted);
    word-break: break-all;
  }

  .error {
    margin: 0.4rem 0 0;
    color: #ffb2a7;
    font-size: 0.8rem;
  }

  .content {
    padding: clamp(1rem, 2vw, 1.6rem);
  }

  .chapter + .chapter {
    margin-top: 1.6rem;
    padding-top: 1.3rem;
    border-top: 1px solid color-mix(in oklab, var(--line) 80%, transparent);
  }

  .chapter h2 {
    margin: 0;
    font-size: 1.2rem;
  }

  .chapter p {
    margin: 0.65rem 0 0;
    font-size: 1.02rem;
    max-width: 72ch;
    color: #f5f9ff;
  }

  @media (max-width: 980px) {
    .reader-grid {
      grid-template-columns: 1fr;
    }

    .toc {
      position: static;
    }
  }
</style>
